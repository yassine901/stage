<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle ?: 'Attijariwafa Bank - Transaction Processor'}">Attijariwafa Bank - Transaction Processor</title>
    <link rel="stylesheet" th:href="@{/css/interface.css}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* Palette Attijariwafa Bank */
            --awb-red: #E31E24;           /* Rouge principal AWB */
            --awb-red-dark: #C41E3A;     /* Rouge foncé */
            --awb-red-light: #FF6B6B;    /* Rouge clair */
            --awb-blue: #003366;         /* Bleu corporate */
            --awb-blue-light: #0056B3;   /* Bleu clair */
            --awb-navy: #1E2A4A;         /* Bleu marine */
            --awb-gray: #6C757D;         /* Gris neutre */
            --awb-gray-light: #F8F9FA;   /* Gris très clair */
            --awb-gold: #FFD700;         /* Or pour accents premium */
            --awb-green: #28A745;        /* Vert succès */
            --awb-orange: #FD7E14;       /* Orange warning */

            /* Couleurs principales de l'interface */
            --primary: var(--awb-red);
            --primary-light: var(--awb-red-light);
            --primary-dark: var(--awb-red-dark);

            --secondary: var(--awb-blue);
            --secondary-light: var(--awb-blue-light);
            --secondary-dark: var(--awb-navy);

            --accent: var(--awb-gold);
            --success: var(--awb-green);
            --warning: var(--awb-orange);
            --error: var(--awb-red-dark);

            /* Arrière-plans avec gradient AWB */
            --bg-primary: linear-gradient(135deg, var(--awb-navy) 0%, var(--awb-blue) 100%);
            --bg-secondary: var(--awb-navy);
            --bg-tertiary: var(--awb-blue);
            --bg-card: rgba(255, 255, 255, 0.08);
            --bg-glass: rgba(255, 255, 255, 0.12);

            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --text-tertiary: rgba(255, 255, 255, 0.6);

            --border-primary: rgba(255, 255, 255, 0.12);
            --border-secondary: rgba(255, 255, 255, 0.08);

            --shadow-sm: 0 2px 4px rgba(227, 30, 36, 0.1);
            --shadow-md: 0 4px 8px rgba(227, 30, 36, 0.15);
            --shadow-lg: 0 8px 16px rgba(227, 30, 36, 0.2);
            --shadow-xl: 0 16px 32px rgba(227, 30, 36, 0.25);
            --shadow-glow: 0 0 24px;

            --radius-xs: 4px;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;

            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
            line-height: 1.6;
        }

        /* Animated Background */
        .bg-animated {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .bg-animated::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                    radial-gradient(circle at 20% 80%, rgba(227, 30, 36, 0.15) 0%, transparent 50%),
                    radial-gradient(circle at 80% 20%, rgba(0, 51, 102, 0.15) 0%, transparent 50%),
                    radial-gradient(circle at 40% 40%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
            animation: bgMove 20s ease-in-out infinite;
        }

        @keyframes bgMove {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(-5%, -10%) rotate(1deg); }
            66% { transform: translate(5%, 5%) rotate(-1deg); }
        }

        /* Floating Orbs */
        .orb {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            filter: blur(1px);
            animation: float 8s ease-in-out infinite;
        }

        .orb:nth-child(1) {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(227, 30, 36, 0.3), transparent);
            top: 10%;
            left: 10%;
            animation-delay: 0s;
        }

        .orb:nth-child(2) {
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(0, 51, 102, 0.25), transparent);
            top: 60%;
            right: 10%;
            animation-delay: 2s;
        }

        .orb:nth-child(3) {
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.2), transparent);
            bottom: 20%;
            left: 20%;
            animation-delay: 4s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        /* Main Container */
        .app-container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--bg-glass);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border-primary);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
            text-decoration: none;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--awb-red), var(--awb-red-dark));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--bg-card);
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius-full);
            border: 1px solid var(--border-primary);
            backdrop-filter: blur(10px);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--awb-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Main Content */
        .main {
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            align-items: start;
        }

        /* Cards */
        .card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-xl);
            padding: 2rem;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            box-shadow: var(--shadow-xl), var(--shadow-glow) var(--primary);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-secondary);
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: var(--awb-red);
            background: rgba(227, 30, 36, 0.1);
            border: 1px solid rgba(227, 30, 36, 0.2);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .form-input {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: 1rem;
            color: var(--text-primary);
            font-size: 1rem;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--awb-red);
            box-shadow: 0 0 0 3px rgba(227, 30, 36, 0.1);
            background: rgba(255, 255, 255, 0.05);
        }

        .form-input::placeholder {
            color: var(--text-tertiary);
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
        }

        .input-group .form-input {
            flex: 1;
        }

        .help-text {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 0.25rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: var(--transition);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--awb-red), var(--awb-red-dark));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            box-shadow: var(--shadow-lg), var(--shadow-glow) var(--awb-red);
        }

        .btn-secondary {
            background: var(--awb-blue);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--awb-green), #218838);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--awb-orange), #E0A800);
            color: white;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* Action Panel */
        .action-panel {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-secondary);
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--awb-red);
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 1rem;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: var(--radius-full);
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--awb-red), var(--awb-gold));
            border-radius: var(--radius-full);
            transition: width 0.6s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: progressShimmer 2s infinite;
        }

        @keyframes progressShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 64px;
            height: 64px;
            border: 4px solid var(--bg-secondary);
            border-top: 4px solid var(--awb-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 2rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .loading-progress {
            width: 300px;
            height: 4px;
            background: var(--bg-secondary);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .loading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--awb-red), var(--awb-gold));
            border-radius: var(--radius-full);
            transition: width 0.3s ease;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .toast {
            background: var(--bg-glass);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 1rem 1.5rem;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: var(--shadow-lg);
            transform: translateX(100%);
            transition: var(--transition);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .toast.success {
            border-left: 4px solid var(--awb-green);
        }

        .toast.error {
            border-left: 4px solid var(--awb-red);
        }

        .toast.warning {
            border-left: 4px solid var(--awb-orange);
        }

        .toast.info {
            border-left: 4px solid var(--awb-blue-light);
        }

        /* Results Section */
        .results-section {
            margin-top: 2rem;
            opacity: 0;
            transform: translateY(20px);
            transition: var(--transition-slow);
        }

        .results-section.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .status-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 2rem;
            transition: var(--transition);
        }

        .status-card.success {
            border-color: var(--awb-green);
            background: rgba(40, 167, 69, 0.1);
        }

        .status-card.error {
            border-color: var(--awb-red-dark);
            background: rgba(196, 30, 58, 0.1);
        }

        .status-icon {
            font-size: 3rem;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .status-card.success .status-icon {
            background: var(--awb-green);
            color: white;
        }

        .status-card.error .status-icon {
            background: var(--awb-red);
            color: white;
        }

        .status-content h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .status-content p {
            color: var(--text-secondary);
        }

        /* Result Grid */
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .result-item {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
            transition: var(--transition);
        }

        .result-item:hover {
            transform: translateY(-2px);
            border-color: var(--awb-red);
        }

        .result-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .result-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-secondary);
        }

        .tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            font-weight: 600;
        }

        .tab:hover {
            color: var(--text-secondary);
        }

        .tab.active {
            color: var(--awb-red);
            border-bottom-color: var(--awb-red);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .code-block {
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            font-family: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--text-secondary);
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .toast.success .toast-icon {
            background: var(--awb-green);
            color: white;
        }

        .toast.error .toast-icon {
            background: var(--awb-red);
            color: white;
        }

        .toast.warning .toast-icon {
            background: var(--awb-orange);
            color: white;
        }

        .toast.info .toast-icon {
            background: var(--awb-blue-light);
            color: white;
        }

        /* Help Panel */
        .help-panel {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.2);
            border-radius: var(--radius-lg);
            padding: 2rem;
        }

        .help-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
        }

        .help-title i {
            color: var(--awb-green);
        }

        .help-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .help-shortcuts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .shortcut {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-secondary);
        }

        .shortcut-key {
            background: var(--bg-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-xs);
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        .shortcut-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: -1;
            }

            .quick-stats {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .main {
                padding: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .quick-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .result-grid {
                grid-template-columns: 1fr;
            }

            .toast-container {
                left: 1rem;
                right: 1rem;
                top: 1rem;
            }

            .toast {
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .header-content {
                padding: 0 1rem;
            }

            .logo {
                font-size: 1.25rem;
            }

            .card {
                padding: 1.5rem;
            }

            .status-card {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .help-shortcuts {
                grid-template-columns: 1fr;
            }
        }

        /* Balance Inquiry Styles */
        .balance-display {
            margin-top: 2rem;
            opacity: 0;
            transform: translateY(20px);
            transition: var(--transition-slow);
        }

        .balance-display.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .balance-card {
            background: linear-gradient(135deg, var(--awb-blue), var(--awb-navy));
            border-radius: var(--radius-lg);
            padding: 2rem;
            color: white;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 70%);
            animation: balanceGlow 3s ease-in-out infinite alternate;
        }

        @keyframes balanceGlow {
            0% { opacity: 0.5; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1.2); }
        }

        .balance-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
        }

        .balance-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--awb-gold);
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .balance-info h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .balance-info p {
            font-size: 0.875rem;
            opacity: 0.8;
            font-family: monospace;
        }

        .balance-amount {
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
        }

        .balance-label {
            font-size: 0.875rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .balance-value {
            font-size: 3rem;
            font-weight: 800;
            color: var(--awb-gold);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            font-family: 'Inter', sans-serif;
        }

        .balance-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            position: relative;
            z-index: 1;
        }

        .balance-detail-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: var(--radius-md);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .detail-label {
            display: block;
            font-size: 0.75rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .detail-value {
            font-size: 1rem;
            font-weight: 600;
            color: white;
        }

        .balance-success {
            animation: balanceSuccess 0.6s ease-out;
        }

        @keyframes balanceSuccess {
            0% { transform: scale(0.95); opacity: 0.8; }
            50% { transform: scale(1.02); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        .balance-error {
            background: linear-gradient(135deg, var(--awb-red), var(--awb-red-dark));
            animation: balanceError 0.6s ease-out;
        }

        @keyframes balanceError {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Loading state for balance */
        .balance-loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .balance-loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--awb-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        .balance-loading-text {
            font-size: 1rem;
            font-weight: 500;
        }

        /* Responsive balance card */
        @media (max-width: 768px) {
            .balance-card {
                padding: 1.5rem;
            }

            .balance-value {
                font-size: 2rem;
            }

            .balance-details {
                grid-template-columns: 1fr;
            }
        }

        /* Styles spécifiques Attijariwafa Bank */
        .awb-brand {
            background: linear-gradient(135deg, var(--awb-red), var(--awb-red-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }

        .awb-accent {
            border-left: 4px solid var(--awb-red);
            padding-left: 1rem;
        }

        .awb-success {
            color: var(--awb-green);
        }

        .awb-warning {
            color: var(--awb-orange);
        }

        .awb-error {
            color: var(--awb-red);
        }

        /* Animation spéciale pour les boutons AWB */
        .btn-awb {
            position: relative;
            background: linear-gradient(135deg, var(--awb-red), var(--awb-red-dark));
            border: none;
            color: white;
            overflow: hidden;
        }

        .btn-awb::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: var(--transition);
        }

        .btn-awb:hover::before {
            left: 100%;
        }

        .btn-awb:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(227, 30, 36, 0.4);
        }

        /* Indicateur de sécurité AWB */
        .security-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.2);
            border-radius: var(--radius-md);
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: var(--awb-green);
            margin-top: 1rem;
        }

        .security-indicator i {
            color: var(--awb-green);
        }

        /* Responsive logo */
        @media (max-width: 768px) {
            .logo span {
                display: none;
            }

            .logo::after {
                content: "AWB";
                font-weight: 800;
                color: var(--awb-red);
                margin-left: 0.5rem;
            }
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #000000;
                --bg-secondary: #111111;
                --bg-tertiary: #1a1a1a;
            }
        }

        /* High Contrast Support */
        @media (prefers-contrast: high) {
            :root {
                --border-primary: rgba(255, 255, 255, 0.3);
                --border-secondary: rgba(255, 255, 255, 0.2);
            }
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                color: black;
            }

            .bg-animated,
            .orb,
            .loading-overlay,
            .toast-container {
                display: none;
            }

            .card {
                border: 1px solid #ccc;
                box-shadow: none;
                background: white;
            }
        }
    </style>
</head>
<body>
<!-- Animated Background -->
<div class="bg-animated">
    <div class="orb"></div>
    <div class="orb"></div>
    <div class="orb"></div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Main App Container -->
<div class="app-container">
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo">
                <div class="logo-icon">
                    <i class="fas fa-university"></i>
                </div>
                <span th:text="${pageTitle ?: 'Attijariwafa Bank - Transaction Processor'}">Attijariwafa Bank - Transaction Processor</span>
            </a>

            <div class="status-indicator">
                <div class="status-dot"></div>
                <span class="status-text" th:text="${environment ?: 'DEVELOPMENT'}">DEVELOPMENT</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="grid">
            <!-- Left Column -->
            <div class="main-content">
                <!-- Configuration Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-cog"></i>
                        </div>
                        <h2 class="card-title">Configuration Endpoint</h2>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">URL Endpoint</label>
                            <input type="text" id="endpoint" class="form-input"
                                   th:value="${defaultEndpoint ?: 'http://localhost:8080/position/v2/transactionProcessor'}"
                                   placeholder="https://api.example.com/v2/transactionProcessor">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Clé/Certificat</label>
                            <input type="text" id="certificat" class="form-input"
                                   th:value="${defaultCertificat ?: 'AZERTYPUI2018AWB'}"
                                   placeholder="Clé de certification">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Version API</label>
                            <div class="stat-value" style="font-size: 1rem; margin: 0.5rem 0;" th:text="${version ?: 'v2.0'}">v2.0</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Environnement</label>
                            <div class="stat-value" style="font-size: 1rem; margin: 0.5rem 0;" th:text="${environment ?: 'DEVELOPMENT'}">DEVELOPMENT</div>
                        </div>
                    </div>
                </div>

                <!-- Balance Inquiry Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <h2 class="card-title">Consultation de Solde</h2>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Numéro de Compte</label>
                            <input type="text" id="balanceAccount" class="form-input"
                                   placeholder="123456789012345" maxlength="15" pattern="\d{15}">
                            <span class="help-text">Exactement 15 chiffres</span>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Canal</label>
                            <select id="balanceCanal" class="form-input">
                                <option value="OPMS" selected>OPMS</option>
                                <option value="EBANK">EBANK</option>
                                <option value="MOBILE">MOBILE</option>
                            </select>
                        </div>
                    </div>

                    <div class="action-panel">
                        <div class="action-buttons">
                            <button type="button" class="btn btn-primary" id="checkBalanceBtn" onclick="checkBalance()">
                                <i class="fas fa-search"></i>
                                Consulter le Solde
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="copyAccountNumber()">
                                <i class="fas fa-copy"></i>
                                Copier du Formulaire
                            </button>
                        </div>
                    </div>

                    <!-- Balance Display -->
                    <div class="balance-display" id="balanceDisplay" style="display: none;">
                        <div class="balance-card">
                            <div class="balance-header">
                                <div class="balance-icon">
                                    <i class="fas fa-credit-card"></i>
                                </div>
                                <div class="balance-info">
                                    <h3>Solde du Compte</h3>
                                    <p id="balanceAccountNumber">-</p>
                                </div>
                            </div>

                            <div class="balance-amount">
                                <div class="balance-label">Solde Disponible</div>
                                <div class="balance-value" id="balanceAmount">-</div>
                            </div>

                            <div class="balance-details">
                                <div class="balance-detail-item">
                                    <span class="detail-label">Dernière MAJ</span>
                                    <span class="detail-value" id="balanceLastUpdate">-</span>
                                </div>
                                <div class="balance-detail-item">
                                    <span class="detail-label">Statut</span>
                                    <span class="detail-value" id="balanceStatus">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transaction Parameters Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-edit"></i>
                        </div>
                        <h2 class="card-title">Paramètres de Transaction</h2>
                    </div>

                    <form id="transactionForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Canal</label>
                                <select id="canal" class="form-input" required>
                                    <option value="OPMS" selected>OPMS</option>
                                    <option value="EBANK">EBANK</option>
                                    <option value="MOBILE">MOBILE</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Utilisateur</label>
                                <input type="text" id="user" class="form-input"
                                       th:value="${defaultUser ?: 'opvuser'}"
                                       placeholder="Nom d'utilisateur" required>
                                <span class="help-text">Utilisateur système autorisé</span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Mot de Passe</label>
                                <input type="password" id="password" class="form-input"
                                       th:value="${defaultPassword ?: 'pa123456'}"
                                       placeholder="••••••••" required>
                                <span class="help-text">Mot de passe en base de données</span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Correlation ID</label>
                                <input type="text" id="correlationId" class="form-input"
                                       value="OPER_INTERFACE_001"
                                       placeholder="ID de corrélation" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Timestamp</label>
                                <div class="input-group">
                                    <input type="text" id="timestamp" class="form-input" readonly>
                                    <button type="button" class="btn btn-small btn-secondary" onclick="updateTimestamp()">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Numéro de Compte</label>
                                <input type="text" id="compte" class="form-input"
                                       th:value="${defaultAccount ?: '001234567890123'}"
                                       maxlength="15" required pattern="\d{15}"
                                       placeholder="123456789012345">
                                <span class="help-text">Exactement 15 chiffres</span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Montant (centimes)</label>
                                <input type="number" id="amount" class="form-input"
                                       th:value="${defaultAmount ?: '50000'}"
                                       min="1" required placeholder="50000">
                                <span class="help-text">Montant en centimes (ex: 50000 = 500 DH)</span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Référence Opération</label>
                                <div class="input-group">
                                    <input type="text" id="operRef" class="form-input"
                                           value="OPER_RESER_001" required>
                                    <button type="button" class="btn btn-small btn-secondary" onclick="manualRegenerateOperRef()">
                                        <i class="fas fa-dice"></i>
                                    </button>
                                </div>
                                <div id="operRefStatus" style="display: none;" class="help-text">
                                    <i class="fas fa-info-circle"></i> <span id="operRefMessage">Référence mise à jour automatiquement</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Code Règle</label>
                                <select id="ruleCode" class="form-input" required>
                                    <option value="RESER" selected>RESER (Réservation)</option>
                                    <option value="OPCAN">OPCAN (Annulation)</option>
                                </select>
                            </div>

                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label class="form-label">Signature SHA1</label>
                                <input type="text" id="signature" class="form-input" readonly
                                       placeholder="Sera générée automatiquement">
                                <div class="signature-status" id="signatureStatus"></div>
                            </div>
                        </div>

                        <!-- Action Panel -->
                        <div class="action-panel">
                            <div class="action-buttons">
                                <button type="button" class="btn btn-warning" onclick="generateSignatureAjax()">
                                    <i class="fas fa-key"></i>
                                    Générer Signature
                                </button>
                                <button type="button" class="btn btn-success" onclick="validateForm()">
                                    <i class="fas fa-check-circle"></i>
                                    Valider Paramètres
                                </button>
                                <button type="submit" class="btn btn-primary" id="executeBtn" disabled>
                                    <i class="fas fa-play"></i>
                                    Exécuter Transaction
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                    <i class="fas fa-trash-alt"></i>
                                    Réinitialiser
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Results Section -->
                <div class="results-section" id="resultSection" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h2 class="card-title">Résultats de la Transaction</h2>
                        </div>

                        <!-- Status Card -->
                        <div class="status-card" id="statusCard">
                            <div class="status-icon" id="statusIcon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="status-content">
                                <h3 id="statusTitle">En attente</h3>
                                <p id="statusMessage">Aucune transaction exécutée</p>
                            </div>
                        </div>

                        <!-- Result Grid -->
                        <div class="result-grid">
                            <div class="result-item">
                                <div class="result-label">Return Code</div>
                                <div class="result-value" id="returnCode">-</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Error Code</div>
                                <div class="result-value" id="errorCode">-</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Message</div>
                                <div class="result-value" id="message">-</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Nouveau Solde</div>
                                <div class="result-value" id="newBalance">-</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Temps de Réponse</div>
                                <div class="result-value" id="responseTime">-</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Timestamp</div>
                                <div class="result-value" id="responseTimestamp">-</div>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="tabs">
                            <button class="tab active" onclick="showTab(event, 'requestTab')">
                                <i class="fas fa-paper-plane"></i> Requête
                            </button>
                            <button class="tab" onclick="showTab(event, 'responseTab')">
                                <i class="fas fa-inbox"></i> Réponse
                            </button>
                            <button class="tab" onclick="showTab(event, 'logsTab')">
                                <i class="fas fa-list-alt"></i> Logs
                            </button>
                        </div>

                        <div class="tab-content active" id="requestTab">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Requête SOAP Envoyée</h4>
                            <div class="code-block" id="rawRequest"></div>
                            <button class="btn btn-small btn-secondary" style="margin-top: 1rem;" onclick="copyToClipboard('rawRequest')">
                                <i class="fas fa-copy"></i> Copier
                            </button>
                        </div>

                        <div class="tab-content" id="responseTab">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Réponse SOAP Reçue</h4>
                            <div class="code-block" id="rawResponse"></div>
                            <button class="btn btn-small btn-secondary" style="margin-top: 1rem;" onclick="copyToClipboard('rawResponse')">
                                <i class="fas fa-copy"></i> Copier
                            </button>
                        </div>

                        <div class="tab-content" id="logsTab">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Logs de Transaction</h4>
                            <div class="code-block" id="transactionLogs"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <aside class="sidebar">
                <!-- Quick Stats -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <h3 class="card-title">Statistiques</h3>
                    </div>

                    <div class="quick-stats">
                        <div class="stat-card">
                            mvn clean install
                            <div class="stat-value" id="totalTransactions">0</div>
                            <div class="stat-label">Transactions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="successRate">0%</div>
                            <div class="stat-label">Taux de Succès</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgResponseTime">0ms</div>
                            <div class="stat-label">Temps Moyen</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="lastUpdate">-</div>
                            <div class="stat-label">Dernière MAJ</div>
                        </div>
                    </div>

                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Fiabilité du système</span>
                            <span id="reliabilityPercent">99.9%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 99.9%"></div>
                        </div>
                    </div>
                </div>

                <!-- Help Panel -->
                <div class="help-panel">
                    <div class="help-title">
                        <i class="fas fa-lightbulb"></i>
                        Aide et Informations
                    </div>

                    <div class="help-content">
                        <h4 style="margin-bottom: 0.5rem; color: var(--awb-green);">Format de Signature:</h4>
                        <code style="background: var(--bg-card); padding: 0.5rem; border-radius: var(--radius-xs); display: block; margin-bottom: 1rem;">
                            SHA1(canal + user + timestamp + account + certificat)
                        </code>

                        <h4 style="margin-bottom: 0.5rem; color: var(--awb-orange);">Codes d'Erreur Fréquents:</h4>
                        <ul style="margin-bottom: 1.5rem; padding-left: 1rem;">
                            <li><strong>99:</strong> Signature requête invalide</li>
                            <li><strong>23:</strong> Compte inexistant</li>
                            <li><strong>06:</strong> Format de compte invalide</li>
                            <li><strong>01:</strong> Erreur métier (solde insuffisant)</li>
                            <li><strong>CORS:</strong> Erreur de politique cross-origin</li>
                        </ul>

                        <h4 style="margin-bottom: 0.5rem; color: var(--awb-red);">Configuration CORS Spring Boot:</h4>
                        <code style="background: var(--bg-card); padding: 0.5rem; border-radius: var(--radius-xs); display: block; margin-bottom: 1rem; font-size: 0.75rem;">
                            @CrossOrigin(origins = "*")<br>
                            @RestController<br>
                            public class TransactionController { ... }
                        </code>

                        <div class="help-shortcuts">
                            <div class="shortcut">
                                <span class="shortcut-key">Ctrl+Enter</span>
                                <span class="shortcut-desc">Exécuter</span>
                            </div>
                            <div class="shortcut">
                                <span class="shortcut-key">Ctrl+G</span>
                                <span class="shortcut-desc">Générer Signature</span>
                            </div>
                            <div class="shortcut">
                                <span class="shortcut-key">F5</span>
                                <span class="shortcut-desc">Actualiser Timestamp</span>
                            </div>
                            <div class="shortcut">
                                <span class="shortcut-key">Ctrl+R</span>
                                <span class="shortcut-desc">Réinitialiser</span>
                            </div>
                        </div>

                        <!-- Ajout d'un footer AWB -->
                        <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-secondary); text-align: center;">
                            <p style="color: var(--text-tertiary); font-size: 0.875rem;">
                                <i class="fas fa-shield-alt" style="color: var(--awb-red); margin-right: 0.5rem;"></i>
                                Attijariwafa Bank - Interface Sécurisée
                            </p>
                            <p style="color: var(--text-tertiary); font-size: 0.75rem; margin-top: 0.5rem;">
                                Simulateur de transactions pour environnement de test
                            </p>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </main>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingSection">
    <div class="loading-spinner"></div>
    <div class="loading-text">Traitement de la transaction en cours...</div>
    <div class="loading-progress">
        <div class="loading-progress-fill" id="progressFill"></div>
    </div>
</div>

<!-- JavaScript -->
<script>
    // Configuration et variables globales
    window.appConfig = {
        defaultEndpoint: 'http://localhost:8080/position/v2/transactionProcessor',
        apiBase: 'http://localhost:8080',
        environment: 'DEVELOPMENT',
        bankName: 'Attijariwafa Bank',
        version: 'v2.1-AWB'
    };

    let transactionInProgress = false;
    let transactionStats = {
        total: 0,
        successful: 0,
        failed: 0,
        totalResponseTime: 0
    };

    // Toast Notification System avec branding AWB
    function showToast(message, type = 'info', duration = 5000) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        const iconMap = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };

        toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${iconMap[type]}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title" style="font-weight: 600; color: var(--text-primary);">${window.appConfig.bankName}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

        container.appendChild(toast);

        // Show animation
        setTimeout(() => toast.classList.add('show'), 100);

        // Auto remove
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (container.contains(toast)) {
                    container.removeChild(toast);
                }
            }, 300);
        }, duration);
    }

    // Animation utilities
    function animateElement(element, animation = 'pulse') {
        element.style.animation = `${animation} 0.3s ease`;
        setTimeout(() => {
            element.style.animation = '';
        }, 300);
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
        updateTimestamp();
        setInterval(updateTimestamp, 1000);

        const form = document.getElementById('transactionForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                executeTransaction();
            });
        }

        // Real-time validation
        ['user', 'compte', 'amount', 'signature'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', validateForm);
            }
        });

        // Balance account validation
        const balanceAccountField = document.getElementById('balanceAccount');
        if (balanceAccountField) {
            balanceAccountField.addEventListener('input', function() {
                validateBalanceAccount();
            });
        }

        // Update balance endpoint display when main endpoint changes
        const endpointField = document.getElementById('endpoint');
        const useSameEndpointCheckbox = document.getElementById('useSameEndpoint');

        if (endpointField) {
            endpointField.addEventListener('input', updateBalanceEndpointDisplay);
            updateBalanceEndpointDisplay(); // Initial update
        }

        if (useSameEndpointCheckbox) {
            useSameEndpointCheckbox.addEventListener('change', updateBalanceEndpointDisplay);
        }

        validateForm();
        showToast('🏦 Interface Attijariwafa Bank chargée avec succès!', 'success');

        console.log('✅ Interface AWB moderne initialisée');
    });

    function updateBalanceEndpointDisplay() {
        const mainEndpoint = document.getElementById('endpoint')?.value || window.appConfig.defaultEndpoint;
        const useSameEndpoint = document.getElementById('useSameEndpoint')?.checked || false;
        const balanceEndpointUrl = document.getElementById('balanceEndpointUrl');

        if (balanceEndpointUrl) {
            let calculatedEndpoint;

            if (useSameEndpoint) {
                // Utiliser exactement le même endpoint
                if (mainEndpoint.startsWith('/')) {
                    calculatedEndpoint = window.location.origin + mainEndpoint;
                } else {
                    calculatedEndpoint = mainEndpoint;
                }
                calculatedEndpoint += ' (même endpoint)';
            } else {
                // Logique originale pour endpoint spécifique
                if (mainEndpoint.startsWith('/')) {
                    const currentOrigin = window.location.origin;
                    if (mainEndpoint.includes('/transactionProcessor')) {
                        calculatedEndpoint = currentOrigin + mainEndpoint.replace('/transactionProcessor', '/balanceInquiry');
                    } else {
                        calculatedEndpoint = currentOrigin + mainEndpoint + '/balanceInquiry';
                    }
                } else if (mainEndpoint.includes('://')) {
                    // URL complète
                    if (mainEndpoint.includes('/transactionProcessor')) {
                        calculatedEndpoint = mainEndpoint.replace('/transactionProcessor', '/balanceInquiry');
                    } else {
                        calculatedEndpoint = mainEndpoint + '/balanceInquiry';
                    }
                } else {
                    // Fallback
                    calculatedEndpoint = window.appConfig.apiBase + '/position/v2/balanceInquiry';
                }
            }

            balanceEndpointUrl.textContent = calculatedEndpoint;
        }
    }

    // Balance inquiry functions
    function validateBalanceAccount() {
        const account = document.getElementById('balanceAccount')?.value || '';
        const checkBalanceBtn = document.getElementById('checkBalanceBtn');

        const isValid = /^\d{15}$/.test(account);

        if (checkBalanceBtn) {
            checkBalanceBtn.disabled = !isValid;
            if (isValid) {
                checkBalanceBtn.classList.remove('btn-secondary');
                checkBalanceBtn.classList.add('btn-primary');
            } else {
                checkBalanceBtn.classList.remove('btn-primary');
                checkBalanceBtn.classList.add('btn-secondary');
            }
        }

        return isValid;
    }

    function copyAccountNumber() {
        const mainAccount = document.getElementById('compte')?.value || '';
        const balanceAccount = document.getElementById('balanceAccount');

        if (balanceAccount && mainAccount) {
            balanceAccount.value = mainAccount;
            animateElement(balanceAccount);
            validateBalanceAccount();
            showToast('📋 Numéro de compte copié depuis le formulaire principal', 'success');
        } else {
            showToast('⚠️ Aucun compte à copier depuis le formulaire principal', 'warning');
        }
    }

    async function checkBalance() {
        const account = document.getElementById('balanceAccount')?.value;
        const canal = document.getElementById('balanceCanal')?.value || 'OPMS';
        const mode = document.querySelector('input[name="balanceMode"]:checked')?.value || 'server';

        if (!validateBalanceAccount()) {
            showToast('❌ Veuillez saisir un numéro de compte valide (15 chiffres)', 'error');
            return;
        }

        const balanceDisplay = document.getElementById('balanceDisplay');
        const checkBalanceBtn = document.getElementById('checkBalanceBtn');

        // Show loading state
        showBalanceLoading();
        checkBalanceBtn.disabled = true;
        checkBalanceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Consultation...';

        try {
            if (mode === 'simulation') {
                // Mode simulation - pas d'appel serveur
                console.log('🎭 Mode simulation activé pour le compte:', account);
                await simulateBalanceInquiry(account);
            } else {
                // Mode serveur - appel API réel
                await performRealBalanceInquiry(account, canal);
            }

        } catch (error) {
            console.error('❌ Erreur consultation solde:', error);

            // Détection automatique des erreurs CORS
            if (error.message.includes('Failed to fetch') || error.message.includes('CORS') || error.message.includes('NetworkError')) {
                console.log('🔄 Détection d\'erreur CORS, basculement automatique en mode simulation...');

                showToast('🔄 Problème CORS détecté, basculement en mode simulation...', 'warning');

                // Attendre un peu puis basculer automatiquement
                setTimeout(async () => {
                    try {
                        await simulateBalanceInquiry(account);
                        showToast('💡 Conseil: Configurez CORS sur votre serveur Spring Boot pour utiliser le mode serveur', 'info', 10000);
                    } catch (simError) {
                        showBalanceError('Erreur en mode simulation: ' + simError.message);
                    }
                }, 1000);

            } else if (error.message.includes('404')) {
                console.log('🔄 Erreur 404 détectée, basculement automatique en mode simulation...');

                showToast('🔄 Endpoint non trouvé, basculement en mode simulation...', 'warning');

                // Attendre un peu puis basculer automatiquement
                setTimeout(async () => {
                    try {
                        await simulateBalanceInquiry(account);
                        showToast('💡 Conseil: Configurez l\'endpoint /balanceInquiry sur votre serveur Spring Boot', 'info', 10000);
                    } catch (simError) {
                        showBalanceError('Erreur en mode simulation: ' + simError.message);
                    }
                }, 1000);

            } else {
                showBalanceError('Erreur technique: ' + error.message);
                showToast('❌ Erreur: ' + error.message, 'error');
            }

            // Ajouter suggestion de test en mode simulation
            addToLogs(`Erreur consultation solde: ${error.message}`);
            if (!error.message.includes('CORS')) {
                setTimeout(() => {
                    showToast('💡 Conseil: Activez le mode simulation pour tester sans serveur', 'info', 8000);
                }, 2000);
            }
        } finally {
            checkBalanceBtn.disabled = false;
            checkBalanceBtn.innerHTML = '<i class="fas fa-search"></i> Consulter le Solde';
            hideBalanceLoading();
        }
    }

    async function simulateBalanceInquiry(account) {
        // Simulation d'un délai réseau
        await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 800));

        // Comptes de test prédéfinis
        const testAccounts = {
            '123456789123456': { balance: 156750, status: 'ACTIF' },     // Votre compte testé
            '123456789012345': { balance: 256750, status: 'ACTIF' },
            '001234567890123': { balance: 89320, status: 'ACTIF' },
            '555444333222111': { balance: 245680, status: 'ACTIF' },
            '999888777666555': { balance: 12500, status: 'BLOQUÉ' },
            '111222333444555': { balance: 0, status: 'VIDE' }
        };

        if (testAccounts[account]) {
            const accountData = testAccounts[account];
            showBalanceSuccess({
                account: account,
                balance: accountData.balance,
                status: accountData.status,
                lastUpdate: new Date().toLocaleString()
            });
            addToLogs(`[SIMULATION] Consultation solde réussie pour ${account}: ${formatBalance(accountData.balance)}`);
            showToast('✅ Solde consulté avec succès (simulation)', 'success');
        } else {
            // Générer des données aléatoires pour les autres comptes
            const randomSuccess = Math.random() > 0.1; // 90% de succès

            if (randomSuccess) {
                const mockBalance = Math.floor(Math.random() * 500000) + 10000; // Entre 100 et 5,100 DH
                showBalanceSuccess({
                    account: account,
                    balance: mockBalance,
                    status: 'ACTIF',
                    lastUpdate: new Date().toLocaleString()
                });
                addToLogs(`[SIMULATION] Consultation solde réussie pour ${account}: ${formatBalance(mockBalance)}`);
                showToast('✅ Solde consulté avec succès (simulation)', 'success');
            } else {
                throw new Error('Compte temporairement indisponible ou inexistant (simulation)');
            }
        }
    }

    async function performRealBalanceInquiry(account, canal) {
        // Récupérer l'endpoint principal configuré
        const mainEndpoint = document.getElementById('endpoint')?.value || window.appConfig.defaultEndpoint;
        const useSameEndpoint = document.getElementById('useSameEndpoint')?.checked || false;

        console.log('🔗 Endpoint principal configuré:', mainEndpoint);
        console.log('🔗 Utiliser même endpoint:', useSameEndpoint);

        // Créer l'endpoint de consultation de solde
        let balanceEndpoint;

        if (useSameEndpoint) {
            // Utiliser exactement le même endpoint que les transactions
            if (mainEndpoint.startsWith('/')) {
                balanceEndpoint = window.location.origin + mainEndpoint;
            } else {
                balanceEndpoint = mainEndpoint;
            }
        } else {
            // Logique originale pour endpoint spécifique
            if (mainEndpoint.startsWith('/')) {
                // URL relative - utiliser l'origine actuelle
                const currentOrigin = window.location.origin;
                if (mainEndpoint.includes('/transactionProcessor')) {
                    balanceEndpoint = currentOrigin + mainEndpoint.replace('/transactionProcessor', '/balanceInquiry');
                } else {
                    // Ajouter /balanceInquiry à la fin du chemin
                    balanceEndpoint = currentOrigin + mainEndpoint + '/balanceInquiry';
                }
            } else if (mainEndpoint.includes('://')) {
                // URL complète
                if (mainEndpoint.includes('/transactionProcessor')) {
                    balanceEndpoint = mainEndpoint.replace('/transactionProcessor', '/balanceInquiry');
                } else {
                    balanceEndpoint = mainEndpoint + '/balanceInquiry';
                }
            } else {
                // Fallback vers la configuration par défaut
                balanceEndpoint = window.appConfig.apiBase + '/position/v2/balanceInquiry';
            }
        }

        console.log('🔍 Endpoint de consultation calculé:', balanceEndpoint);

        const balanceRequest = buildBalanceRequest(account, canal);
        console.log('📤 Requête de consultation:', balanceRequest);

        let response;
        let responseText;

        try {
            // Première tentative avec l'endpoint calculé
            response = await fetch(balanceEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/xml; charset=utf-8',
                    'Accept': 'application/xml',
                    'SOAPAction': 'balanceInquiry'
                },
                body: balanceRequest
            });
            responseText = await response.text();
            console.log('📥 Réponse (endpoint calculé):', responseText);

        } catch (fetchError) {
            console.log('⚠️ Endpoint calculé indisponible, tentative avec endpoint principal...');

            // Fallback: utiliser l'endpoint principal directement
            let fallbackEndpoint;
            if (mainEndpoint.startsWith('/')) {
                fallbackEndpoint = window.location.origin + mainEndpoint;
            } else {
                fallbackEndpoint = mainEndpoint;
            }

            console.log('🔄 Tentative fallback sur:', fallbackEndpoint);

            response = await fetch(fallbackEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/xml; charset=utf-8',
                    'Accept': 'application/xml',
                    'SOAPAction': 'balanceInquiry'
                },
                body: balanceRequest
            });
            responseText = await response.text();
            console.log('📥 Réponse (fallback):', responseText);
        }

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        parseBalanceResponse(responseText, account);
    }

    function buildBalanceRequest(account, canal) {
        const timestamp = new Date().toISOString().slice(0, 19).replace('T', ' ');
        const user = 'opvuser'; // Utilisateur par défaut pour consultation
        const correlationId = 'BALANCE_' + Date.now();

        return `<?xml version="1.0" encoding="UTF-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
    <soap:Body>
        <balanceInquiryReq xmlns="urn:schemas-attijariwafa-com:balance-data">
            <ReqHeader canal="${canal}"
                       user="${user}"
                       correlationId="${correlationId}"
                       ts="${timestamp}"
                       replyFormat="FULL"/>
            <BalanceReq>
                <AccountData account="${account}"
                            canal="${canal}"
                            inquiryType="AVAILABLE_BALANCE"/>
            </BalanceReq>
        </balanceInquiryReq>
    </soap:Body>
</soap:Envelope>`;
    }

    function parseBalanceResponse(xmlText, account) {
        try {
            // Simulation d'une réponse réussie (à adapter selon votre vraie API)
            const mockSuccessResponse = Math.random() > 0.2; // 80% de succès

            if (mockSuccessResponse) {
                // Générer un solde aléatoire pour la démonstration
                const mockBalance = Math.floor(Math.random() * 1000000) + 50000; // Entre 500 et 10,500 DH

                showBalanceSuccess({
                    account: account,
                    balance: mockBalance,
                    status: 'ACTIF',
                    lastUpdate: new Date().toLocaleString()
                });

                addToLogs(`Consultation solde réussie pour le compte ${account}`);
                showToast('✅ Solde consulté avec succès', 'success');
            } else {
                showBalanceError('Compte non trouvé ou temporairement indisponible');
                addToLogs(`Échec consultation solde pour le compte ${account}`);
            }
        } catch (error) {
            console.error('Erreur parsing réponse solde:', error);
            showBalanceError('Erreur lors de l\'analyse de la réponse');
        }
    }

    function showBalanceLoading() {
        const balanceDisplay = document.getElementById('balanceDisplay');
        if (balanceDisplay) {
            balanceDisplay.style.display = 'block';
            balanceDisplay.innerHTML = `
                    <div class="balance-loading">
                        <div class="balance-loading-spinner"></div>
                        <div class="balance-loading-text">Consultation en cours...</div>
                    </div>
                `;
            balanceDisplay.classList.add('visible');
        }
    }

    function hideBalanceLoading() {
        // La fonction sera appelée après l'affichage du résultat
    }

    function showBalanceSuccess(data) {
        const balanceDisplay = document.getElementById('balanceDisplay');
        if (balanceDisplay) {
            balanceDisplay.innerHTML = `
                    <div class="balance-card balance-success">
                        <div class="balance-header">
                            <div class="balance-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <div class="balance-info">
                                <h3>Solde du Compte</h3>
                                <p>${data.account}</p>
                            </div>
                        </div>

                        <div class="balance-amount">
                            <div class="balance-label">Solde Disponible</div>
                            <div class="balance-value">${formatBalance(data.balance)}</div>
                        </div>

                        <div class="balance-details">
                            <div class="balance-detail-item">
                                <span class="detail-label">Dernière MAJ</span>
                                <span class="detail-value">${data.lastUpdate}</span>
                            </div>
                            <div class="balance-detail-item">
                                <span class="detail-label">Statut</span>
                                <span class="detail-value">${data.status}</span>
                            </div>
                        </div>
                    </div>
                `;
            balanceDisplay.classList.add('visible');

            // Animation de succès
            setTimeout(() => {
                const balanceCard = balanceDisplay.querySelector('.balance-card');
                if (balanceCard) {
                    balanceCard.classList.add('balance-success');
                }
            }, 100);
        }
    }

    function showBalanceError(message) {
        const balanceDisplay = document.getElementById('balanceDisplay');
        if (balanceDisplay) {
            balanceDisplay.innerHTML = `
                    <div class="balance-card balance-error">
                        <div class="balance-header">
                            <div class="balance-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="balance-info">
                                <h3>Erreur de Consultation</h3>
                                <p>Impossible d'obtenir le solde</p>
                            </div>
                        </div>

                        <div class="balance-amount">
                            <div class="balance-label">Message d'Erreur</div>
                            <div class="balance-value" style="font-size: 1.5rem; color: white;">${message}</div>
                        </div>
                    </div>
                `;
            balanceDisplay.classList.add('visible');
            showToast('❌ ' + message, 'error');
        }
    }

    // Core functions (keeping the same logic but with enhanced UI)
    function updateTimestamp() {
        const now = new Date();
        const timestamp = now.getFullYear() + '-' +
            String(now.getMonth() + 1).padStart(2, '0') + '-' +
            String(now.getDate()).padStart(2, '0') + ' ' +
            String(now.getHours()).padStart(2, '0') + ':' +
            String(now.getMinutes()).padStart(2, '0') + ':' +
            String(now.getSeconds()).padStart(2, '0');

        const timestampElement = document.getElementById('timestamp');
        if (timestampElement) {
            timestampElement.value = timestamp;
        }

        // Update last update stat
        const lastUpdateElement = document.getElementById('lastUpdate');
        if (lastUpdateElement) {
            lastUpdateElement.textContent = now.toLocaleTimeString();
        }
    }

    function manualRegenerateOperRef() {
        const now = new Date();
        const timestamp = now.getTime();
        const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        const dateStr = now.getFullYear().toString().slice(-2) +
            String(now.getMonth() + 1).padStart(2, '0') +
            String(now.getDate()).padStart(2, '0');

        const operRef = `OPER_${dateStr}_${timestamp}_${random}`;
        const operRefElement = document.getElementById('operRef');

        if (operRefElement) {
            operRefElement.value = operRef;
            animateElement(operRefElement);
        }

        // Clear signature if it exists
        const signatureElement = document.getElementById('signature');
        if (signatureElement && signatureElement.value) {
            signatureElement.value = '';
            showToast('⚠️ Signature effacée - Veuillez régénérer après changement de référence', 'warning');

            if (window.transactionData) {
                window.transactionData = {
                    timestamp: null,
                    signature: null,
                    canal: null,
                    user: null,
                    account: null
                };
            }
        }

        validateForm();
        showToast('🎲 Nouvelle référence générée manuellement', 'info');
    }

    async function generateSignatureAjax() {
        const canal = document.getElementById('canal')?.value || 'OPMS';
        const user = document.getElementById('user')?.value || 'opvuser';
        const account = document.getElementById('compte')?.value;

        if (!user || !account) {
            showToast('❌ Veuillez remplir tous les champs requis', 'error');
            return;
        }

        try {
            showToast('⏳ Génération de signature...', 'info');

            const fixedTimestamp = document.getElementById('timestamp')?.value;

            window.transactionData = {
                timestamp: fixedTimestamp,
                canal: canal,
                user: user,
                account: account,
                signature: null
            };

            console.log('🕒 Timestamp FIGÉ pour la transaction:', fixedTimestamp);

            const url = `${window.appConfig.apiBase}/position/v2/generate-test-signature?canal=${canal}&user=${user}&timestamp=${encodeURIComponent(fixedTimestamp)}&account=${account}`;

            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (data.signature) {
                window.transactionData.signature = data.signature;

                const signatureElement = document.getElementById('signature');
                if (signatureElement) {
                    signatureElement.value = data.signature;
                    animateElement(signatureElement);
                }

                console.log('✅ Données de transaction synchronisées:', window.transactionData);
                showToast('🔐 Signature générée avec succès!', 'success');
                validateForm();
            } else if (data.error) {
                showToast('❌ Erreur: ' + data.error, 'error');
            } else {
                showToast('❌ Réponse inattendue du serveur', 'error');
            }

        } catch (error) {
            console.error('Erreur:', error);
            showToast('❌ Erreur: ' + error.message, 'error');
        }
    }

    function validateForm() {
        const account = document.getElementById('compte')?.value || '';
        const amount = document.getElementById('amount')?.value || '';
        const user = document.getElementById('user')?.value || '';
        const signature = document.getElementById('signature')?.value || '';

        const isAccountValid = /^\d{15}$/.test(account);
        const isAmountValid = !isNaN(amount) && parseInt(amount) > 0;
        const isUserValid = user.trim().length > 0;
        const hasSignature = signature.length > 0;

        const allValid = isAccountValid && isAmountValid && isUserValid && hasSignature;

        const executeBtn = document.getElementById('executeBtn');
        if (executeBtn) {
            executeBtn.disabled = !allValid;
            if (allValid) {
                executeBtn.innerHTML = '<i class="fas fa-play"></i> Exécuter Transaction';
                executeBtn.className = 'btn btn-primary';
            } else {
                executeBtn.innerHTML = '<i class="fas fa-times"></i> Paramètres invalides';
                executeBtn.className = 'btn btn-secondary';
            }
        }

        return allValid;
    }

    async function executeTransaction() {
        if (transactionInProgress) {
            showToast('⚠️ Une transaction est déjà en cours', 'warning');
            return;
        }

        if (!validateForm()) {
            showToast('❌ Veuillez corriger les erreurs', 'error');
            return;
        }

        transactionInProgress = true;
        showLoadingSection();

        const startTime = Date.now();
        const soapRequest = buildSoapRequest();
        document.getElementById('rawRequest').textContent = soapRequest;

        try {
            const endpoint = window.appConfig.defaultEndpoint;
            console.log('🔗 Endpoint utilisé:', endpoint);

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/xml; charset=utf-8',
                    'Accept': 'application/xml',
                    'SOAPAction': 'processTransaction'
                },
                body: soapRequest
            });

            const responseText = await response.text();
            const responseTime = Date.now() - startTime;

            document.getElementById('rawResponse').textContent = responseText;

            // Update stats
            transactionStats.total++;
            transactionStats.totalResponseTime += responseTime;
            updateStats();

            parseAndDisplayResponse(responseText, responseTime);

        } catch (error) {
            console.error('Erreur:', error);
            showToast('❌ Erreur: ' + error.message, 'error');
            transactionStats.total++;
            transactionStats.failed++;
            updateStats();
        } finally {
            transactionInProgress = false;
            hideLoadingSection();
            showResultSection();
        }
    }

    function updateStats() {
        const totalElement = document.getElementById('totalTransactions');
        const successRateElement = document.getElementById('successRate');
        const avgTimeElement = document.getElementById('avgResponseTime');

        if (totalElement) {
            totalElement.textContent = transactionStats.total;
            animateElement(totalElement);
        }

        if (successRateElement && transactionStats.total > 0) {
            const rate = ((transactionStats.successful / transactionStats.total) * 100).toFixed(1);
            successRateElement.textContent = rate + '%';
            animateElement(successRateElement);
        }

        if (avgTimeElement && transactionStats.total > 0) {
            const avgTime = Math.round(transactionStats.totalResponseTime / transactionStats.total);
            avgTimeElement.textContent = avgTime + 'ms';
            animateElement(avgTimeElement);
        }
    }

    function buildSoapRequest() {
        const canal = window.transactionData.canal || document.getElementById('canal')?.value || 'OPMS';
        const user = window.transactionData.user || document.getElementById('user')?.value || 'opvuser';
        const timestamp = window.transactionData.timestamp || document.getElementById('timestamp')?.value;
        const signature = window.transactionData.signature || document.getElementById('signature')?.value || '';
        const account = window.transactionData.account || document.getElementById('compte')?.value || '';

        const password = document.getElementById('password')?.value || 'pa123456';
        const correlationId = document.getElementById('correlationId')?.value || 'OPER_001';
        const amount = document.getElementById('amount')?.value || '50000';
        const operRef = document.getElementById('operRef')?.value || 'OPER_001';
        const ruleCode = document.getElementById('ruleCode')?.value || 'RESER';

        const currentDate = new Date().toISOString().slice(0,10).replace(/-/g,'');

        console.log('🔧 Construction SOAP avec timestamp figé:', timestamp);
        console.log('🔧 Signature utilisée:', signature);

        return `<?xml version="1.0" encoding="UTF-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
    <soap:Body>
        <operationExecReq xmlns="urn:schemas-attijariwafa-com:transaction-data">
            <ReqHeader canal="${canal}"
                       user="${user}"
                       password="${password}"
                       signature="${signature}"
                       correlationId="${correlationId}"
                       ts="${timestamp}"
                       replyFormat="FULL"/>
            <OperExeReq>
                <OperationData ruleCode="${ruleCode}"
                               operRef="${operRef}"
                               canal="${canal}"
                               operType="GOD01"
                               operStatus="OCI"
                               account="${account}"
                               amount="${amount}"
                               sens="D"
                               operDate="${currentDate}"
                               valueDate="${currentDate}"
                               endDate="${currentDate}"
                               operLib="Transaction Interface Web Moderne"
                               operLib2="Test Intégré"
                               operLib3="Next Generation UI"
                               libCourt="WEBTEST"/>
            </OperExeReq>
        </operationExecReq>
    </soap:Body>
</soap:Envelope>`;
    }

    function parseAndDisplayResponse(xmlText, responseTime) {
        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");

            const returnCode = getXmlValue(xmlDoc, "ReturnCode") || "-";
            const errorCode = getXmlValue(xmlDoc, "ErrorCode") || "-";
            const message = getXmlValue(xmlDoc, "ReturnMessage") || "-";
            const newBalance = getXmlValue(xmlDoc, "NewAvailBal") || "-";

            // Update result elements
            document.getElementById('returnCode').textContent = returnCode;
            document.getElementById('errorCode').textContent = errorCode;
            document.getElementById('message').textContent = message;
            document.getElementById('newBalance').textContent = newBalance !== "-" ? formatBalance(newBalance) : "-";
            document.getElementById('responseTime').textContent = responseTime + "ms";
            document.getElementById('responseTimestamp').textContent = new Date().toLocaleString();

            // Update stats
            if (returnCode === "0") {
                transactionStats.successful++;
            } else {
                transactionStats.failed++;
            }

            updateStatusCard(returnCode, errorCode, message);
            addToLogs(`Transaction ${returnCode === "0" ? "réussie" : "échouée"} - Code: ${returnCode}`);

            // Contextual advice
            if (returnCode === "1" && errorCode === "16") {
                console.log('🔍 Détection: Référence d\'opération déjà existante');
                showToast('💡 Conseil: Cliquez sur "🎲" pour créer une nouvelle référence unique', 'info', 8000);
            } else if (returnCode === "0") {
                console.log('🔍 Détection: Transaction réussie');
                const ruleCode = document.getElementById('ruleCode')?.value;
                if (ruleCode === 'RESER') {
                    showToast('✅ Réservation réussie! Vous pouvez maintenant faire une annulation (OPCAN)', 'success', 6000);
                } else {
                    showToast('✅ Annulation réussie! Vous pouvez faire une nouvelle réservation', 'success', 6000);
                }
            }

        } catch (error) {
            console.error('Erreur parsing XML:', error);
            showToast('❌ Erreur lors de l\'analyse de la réponse', 'error');
            addToLogs(`Erreur parsing XML: ${error.message}`);
        }
    }

    function getXmlValue(xmlDoc, tagName) {
        const elements = xmlDoc.getElementsByTagName(tagName);
        return elements.length > 0 ? elements[0].textContent : null;
    }

    function updateStatusCard(returnCode, errorCode, message) {
        const statusCard = document.getElementById('statusCard');
        const statusIcon = document.getElementById('statusIcon');
        const statusTitle = document.getElementById('statusTitle');
        const statusMessage = document.getElementById('statusMessage');

        // Remove previous classes
        statusCard.classList.remove('success', 'error');

        if (returnCode === "0") {
            statusCard.classList.add('success');
            statusIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            statusTitle.textContent = 'Transaction Réussie';
            statusMessage.textContent = message;
            animateElement(statusCard, 'pulse');
        } else {
            statusCard.classList.add('error');
            statusIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
            statusTitle.textContent = 'Transaction Échouée';
            statusMessage.textContent = `Erreur ${errorCode}: ${message}`;
            animateElement(statusCard, 'shake');
        }
    }

    function formatBalance(centimes) {
        const dh = parseInt(centimes) / 100;
        return dh.toLocaleString('fr-FR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }) + ' DH';
    }

    function showLoadingSection() {
        const loadingSection = document.getElementById('loadingSection');
        const resultSection = document.getElementById('resultSection');

        if (loadingSection) {
            loadingSection.classList.add('active');
        }
        if (resultSection) {
            resultSection.style.display = 'none';
        }

        // Animate progress bar
        const progressFill = document.getElementById('progressFill');
        if (progressFill) {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) {
                    clearInterval(interval);
                    progress = 90;
                }
                progressFill.style.width = progress + '%';
            }, 200);

            window.progressInterval = interval;
        }
    }

    function hideLoadingSection() {
        const loadingSection = document.getElementById('loadingSection');
        if (loadingSection) {
            loadingSection.classList.remove('active');
        }

        const progressFill = document.getElementById('progressFill');
        if (progressFill) {
            progressFill.style.width = '100%';
        }

        if (window.progressInterval) {
            clearInterval(window.progressInterval);
        }
    }

    function showResultSection() {
        const resultSection = document.getElementById('resultSection');
        if (resultSection) {
            resultSection.style.display = 'block';
            resultSection.classList.add('visible');
        }
    }

    function showTab(event, tabId) {
        // Hide all tab contents
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => content.classList.remove('active'));

        // Remove active class from all tabs
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => tab.classList.remove('active'));

        // Activate clicked tab
        event.target.classList.add('active');
        const targetTab = document.getElementById(tabId);
        if (targetTab) {
            targetTab.classList.add('active');
        }
    }

    function resetForm() {
        // Reset frozen data
        window.transactionData = {
            timestamp: null,
            signature: null,
            canal: null,
            user: null,
            account: null
        };

        // Reset form fields
        const fields = {
            'user': 'opvuser',
            'password': 'pa123456',
            'compte': '001234567890123',
            'amount': '50000',
            'canal': 'OPMS',
            'ruleCode': 'RESER',
            'signature': '',
            'correlationId': 'OPER_INTERFACE_001'
        };

        Object.entries(fields).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.value = value;
                animateElement(element);
            }
        });

        manualRegenerateOperRef();
        updateTimestamp();
        validateForm();

        // Hide results
        const resultSection = document.getElementById('resultSection');
        if (resultSection) {
            resultSection.style.display = 'none';
            resultSection.classList.remove('visible');
        }

        showToast('🔄 Formulaire réinitialisé', 'info');
        addToLogs('Formulaire réinitialisé');
    }

    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;

        const text = element.textContent;

        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('📋 Contenu copié dans le presse-papiers', 'success');
            }).catch(err => {
                console.error('Erreur copie:', err);
                showToast('❌ Erreur lors de la copie', 'error');
            });
        } else {
            // Fallback
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('📋 Contenu copié dans le presse-papiers', 'success');
            } catch (err) {
                showToast('❌ Erreur lors de la copie', 'error');
            }
            document.body.removeChild(textArea);
        }
    }

    function addToLogs(message) {
        const logsArea = document.getElementById('transactionLogs');
        if (logsArea) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logsArea.textContent += logEntry;
            logsArea.scrollTop = logsArea.scrollHeight;
        }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        if (event.ctrlKey && event.key === 'Enter') {
            event.preventDefault();
            if (!transactionInProgress) {
                executeTransaction();
            }
        }

        if (event.ctrlKey && event.key.toLowerCase() === 'g') {
            event.preventDefault();
            generateSignatureAjax();
        }

        if (event.key === 'F5') {
            event.preventDefault();
            updateTimestamp();
            showToast('🕒 Timestamp actualisé', 'info');
        }

        if (event.ctrlKey && event.key.toLowerCase() === 'r') {
            event.preventDefault();
            resetForm();
        }
    });

    // Enhanced animations with CSS custom properties
    function createPulseAnimation(element) {
        element.style.setProperty('--pulse-color', '#E31E24');
        element.classList.add('pulse-animation');
        setTimeout(() => {
            element.classList.remove('pulse-animation');
        }, 600);
    }

    function createShakeAnimation(element) {
        element.classList.add('shake-animation');
        setTimeout(() => {
            element.classList.remove('shake-animation');
        }, 600);
    }

    // Add CSS for animations
    const animationStyles = `
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }

            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }

            .pulse-animation {
                animation: pulse 0.6s ease-in-out;
            }

            .shake-animation {
                animation: shake 0.6s ease-in-out;
            }
        `;

    const styleSheet = document.createElement('style');
    styleSheet.textContent = animationStyles;
    document.head.appendChild(styleSheet);

    // Initialize theme switcher (bonus feature)
    function initializeTheme() {
        const savedTheme = localStorage.getItem('transaction-theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
    }

    // Performance monitoring
    function monitorPerformance() {
        const observer = new PerformanceObserver((list) => {
            for (const entry of list.getEntries()) {
                if (entry.entryType === 'navigation') {
                    console.log(`Page load time: ${entry.loadEventEnd - entry.loadEventStart}ms`);
                }
            }
        });
        observer.observe({entryTypes: ['navigation']});
    }

    // Initialize everything
    document.addEventListener('DOMContentLoaded', function() {
        initializeTheme();
        monitorPerformance();

        // Add some initial logs
        addToLogs('Application initialisée');
        addToLogs('Interface moderne chargée');

        console.log('🎨 Interface ultra-moderne prête!');
    });

    // Export functions for potential testing
    window.TransactionProcessor = {
        generateSignature: generateSignatureAjax,
        executeTransaction,
        validateForm,
        resetForm,
        showToast,
        updateStats,
        checkBalance,
        copyAccountNumber,
        validateBalanceAccount,
        stats: transactionStats
    };
</script>
</body>
</html>